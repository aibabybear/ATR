{% extends "base.html" %}

{% block title %}AI Trading Robot - é¦–é¡µ{% endblock %}

{% block content %}
<div class="row">
    <!-- æ¬¢è¿åŒºåŸŸ -->
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-robot" style="font-size: 4rem; color: var(--secondary-color);"></i>
                </div>
                <h1 class="display-4 mb-3">AI Trading Robot</h1>
                <p class="lead mb-4">å¤šAIæ¨¡å‹è‡ªåŠ¨äº¤æ˜“ç³»ç»Ÿ - è®©äººå·¥æ™ºèƒ½ä¸ºæ‚¨çš„æŠ•èµ„å†³ç­–</p>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <p class="text-muted">
                            åŸºäºå…ˆè¿›çš„äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œé›†æˆå¤šä¸ªAIæ¨¡å‹è¿›è¡Œè‚¡ç¥¨å¸‚åœºåˆ†æå’Œè‡ªåŠ¨äº¤æ˜“ã€‚
                            ç³»ç»Ÿæ”¯æŒGPTã€Claudeç­‰å¤šç§AIæ¨¡å‹ï¼Œé€šè¿‡ç«äº‰æœºåˆ¶é€‰å‡ºæœ€ä¼˜ç­–ç•¥ã€‚
                        </p>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="/dashboard" class="btn btn-primary btn-custom btn-lg me-3">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        è¿›å…¥ä»ªè¡¨æ¿
                    </a>
                    <a href="/models" class="btn btn-outline-secondary btn-custom btn-lg">
                        <i class="fas fa-brain me-2"></i>
                        æŸ¥çœ‹AIæ¨¡å‹
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ç³»ç»Ÿæ¦‚è§ˆ -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    ç³»ç»Ÿæ¦‚è§ˆ
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="system-overview">
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center">
                            <div class="metric-value" id="active-models">-</div>
                            <div class="metric-label">æ´»è·ƒæ¨¡å‹</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <div class="metric-value" id="total-trades">-</div>
                            <div class="metric-label">æ€»äº¤æ˜“æ¬¡æ•°</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="metric-value" id="avg-return">-</div>
                            <div class="metric-label">å¹³å‡æ”¶ç›Šç‡</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="metric-card text-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="metric-value" id="market-status">-</div>
                            <div class="metric-label">å¸‚åœºçŠ¶æ€</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¨¡å‹æ’è¡Œæ¦œ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    AIæ¨¡å‹æ’è¡Œæ¦œ
                </h5>
            </div>
            <div class="card-body">
                <div id="rankings-container">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="mt-2 text-muted">åŠ è½½æ’è¡Œæ¦œæ•°æ®...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="col-lg-4">
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    å¿«é€Ÿæ“ä½œ
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-custom" onclick="startTrading()">
                        <i class="fas fa-play me-2"></i>
                        å¯åŠ¨äº¤æ˜“
                    </button>
                    <button class="btn btn-warning btn-custom" onclick="pauseTrading()">
                        <i class="fas fa-pause me-2"></i>
                        æš‚åœäº¤æ˜“
                    </button>
                    <button class="btn btn-info btn-custom" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>
                        åˆ·æ–°æ•°æ®
                    </button>
                    <button class="btn btn-secondary btn-custom" onclick="exportData()">
                        <i class="fas fa-download me-2"></i>
                        å¯¼å‡ºæ•°æ®
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å¸‚åœºä¿¡æ¯ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-globe me-2"></i>
                    å¸‚åœºä¿¡æ¯
                </h5>
            </div>
            <div class="card-body">
                <div id="market-info">
                    <div class="text-center py-3">
                        <div class="loading-spinner"></div>
                        <p class="mt-2 text-muted">åŠ è½½å¸‚åœºæ•°æ®...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>
                    ç³»ç»Ÿæ—¥å¿—
                </h5>
            </div>
            <div class="card-body">
                <div id="system-logs" style="height: 300px; overflow-y: auto;">
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle text-muted"></i>
                        <p class="mt-2 text-muted">ç­‰å¾…ç³»ç»Ÿæ—¥å¿—...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åŠŸèƒ½ç‰¹æ€§ -->
<div class="row mt-5">
    <div class="col-12">
        <h2 class="text-center mb-5">æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§</h2>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-brain" style="font-size: 3rem; color: var(--primary-color);"></i>
                </div>
                <h5 class="card-title">å¤šAIæ¨¡å‹ç«äº‰</h5>
                <p class="card-text">
                    é›†æˆGPTã€Claudeç­‰å¤šç§AIæ¨¡å‹ï¼Œé€šè¿‡ç«äº‰æœºåˆ¶è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜äº¤æ˜“ç­–ç•¥ï¼Œ
                    ç¡®ä¿æŠ•èµ„å†³ç­–çš„å¤šæ ·æ€§å’Œå‡†ç¡®æ€§ã€‚
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-shield-alt" style="font-size: 3rem; color: var(--success-color);"></i>
                </div>
                <h5 class="card-title">æ™ºèƒ½é£é™©ç®¡ç†</h5>
                <p class="card-text">
                    å†…ç½®å…ˆè¿›çš„é£é™©ç®¡ç†ç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§æŠ•èµ„ç»„åˆé£é™©ï¼Œ
                    è‡ªåŠ¨è®¾ç½®æ­¢æŸæ­¢ç›ˆï¼Œä¿æŠ¤æ‚¨çš„æŠ•èµ„å®‰å…¨ã€‚
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-chart-area" style="font-size: 3rem; color: var(--info-color);"></i>
                </div>
                <h5 class="card-title">å®æ—¶æ•°æ®åˆ†æ</h5>
                <p class="card-text">
                    æ•´åˆå¤šæºå¸‚åœºæ•°æ®ï¼ŒåŒ…æ‹¬å®æ—¶ä»·æ ¼ã€æ–°é—»æƒ…ç»ªã€æŠ€æœ¯æŒ‡æ ‡ç­‰ï¼Œ
                    ä¸ºAIæ¨¡å‹æä¾›å…¨é¢çš„å†³ç­–ä¾æ®ã€‚
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é¡µé¢ç‰¹å®šçš„JavaScript
    let systemData = {};
    
    // åŠ è½½ç³»ç»Ÿæ¦‚è§ˆæ•°æ®
    async function loadSystemOverview() {
        try {
            const [statusData, performanceData] = await Promise.all([
                apiRequest('/api/status'),
                apiRequest('/api/performance')
            ]);
            
            // æ›´æ–°ç³»ç»Ÿæ¦‚è§ˆ
            document.getElementById('active-models').textContent = statusData.active_models || 0;
            document.getElementById('total-trades').textContent = performanceData.total_trades || 0;
            document.getElementById('avg-return').textContent = formatPercentage(performanceData.average_return || 0);
            document.getElementById('market-status').textContent = statusData.market_open ? 'å¼€ç›˜' : 'ä¼‘å¸‚';
            
            systemData = { ...statusData, ...performanceData };
            
        } catch (error) {
            console.error('åŠ è½½ç³»ç»Ÿæ¦‚è§ˆå¤±è´¥:', error);
            showError('system-overview', 'åŠ è½½ç³»ç»Ÿæ•°æ®å¤±è´¥');
        }
    }
    
    // åŠ è½½æ’è¡Œæ¦œæ•°æ®
    async function loadRankings() {
        try {
            const rankings = await apiRequest('/api/rankings');
            
            const container = document.getElementById('rankings-container');
            
            if (rankings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle text-muted"></i>
                        <p class="mt-2 text-muted">æš‚æ— AIæ¨¡å‹æ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive">';
            html += '<table class="table table-hover">';
            html += `
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>AIæ¨¡å‹</th>
                        <th>æ€»æ”¶ç›Š</th>
                        <th>èƒœç‡</th>
                        <th>äº¤æ˜“æ¬¡æ•°</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            rankings.slice(0, 5).forEach((model, index) => {
                const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
                const returnClass = model.total_return >= 0 ? 'text-success' : 'text-danger';
                const statusBadge = model.is_active ? 
                    '<span class="badge bg-success">æ´»è·ƒ</span>' : 
                    '<span class="badge bg-secondary">åœç”¨</span>';
                
                html += `
                    <tr>
                        <td><span style="font-size: 1.2em;">${rankIcon}</span></td>
                        <td><strong>${model.model_name}</strong></td>
                        <td class="${returnClass}"><strong>${formatCurrency(model.total_return)}</strong></td>
                        <td>${formatPercentage(model.win_rate)}</td>
                        <td>${model.total_trades}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            
        } catch (error) {
            console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
            showError('rankings-container', 'åŠ è½½æ’è¡Œæ¦œæ•°æ®å¤±è´¥');
        }
    }
    
    // åŠ è½½å¸‚åœºä¿¡æ¯
    async function loadMarketInfo() {
        try {
            const marketData = await apiRequest('/api/market-data?symbols=QQQ,SPY,VIX');
            
            const container = document.getElementById('market-info');
            let html = '';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                const changeClass = data.change >= 0 ? 'text-success' : 'text-danger';
                const changeIcon = data.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <strong>${symbol}</strong>
                            <div class="small text-muted">${data.source}</div>
                        </div>
                        <div class="text-end">
                            <div><strong>$${data.price.toFixed(2)}</strong></div>
                            <div class="small ${changeClass}">
                                <i class="fas ${changeIcon}"></i>
                                ${data.change_percent.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-muted">æš‚æ— å¸‚åœºæ•°æ®</p>';
            
        } catch (error) {
            console.error('åŠ è½½å¸‚åœºä¿¡æ¯å¤±è´¥:', error);
            showError('market-info', 'åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥');
        }
    }
    
    // å¿«é€Ÿæ“ä½œå‡½æ•°
    function startTrading() {
        // è¿™é‡Œåº”è¯¥è°ƒç”¨å¯åŠ¨äº¤æ˜“çš„API
        alert('å¯åŠ¨äº¤æ˜“åŠŸèƒ½å¼€å‘ä¸­...');
    }
    
    function pauseTrading() {
        // è¿™é‡Œåº”è¯¥è°ƒç”¨æš‚åœäº¤æ˜“çš„API
        alert('æš‚åœäº¤æ˜“åŠŸèƒ½å¼€å‘ä¸­...');
    }
    
    function refreshData() {
        loadSystemOverview();
        loadRankings();
        loadMarketInfo();
    }
    
    function exportData() {
        // è¿™é‡Œåº”è¯¥å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½
        alert('æ•°æ®å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
    }
    
    // WebSocketäº‹ä»¶å¤„ç†
    socket.on('live_update', function(data) {
        console.log('æ”¶åˆ°å®æ—¶æ›´æ–°:', data);
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        if (data.system_status) {
            const status = data.system_status;
            document.getElementById('active-models').textContent = status.active_models;
            document.getElementById('market-status').textContent = status.market_open ? 'å¼€ç›˜' : 'ä¼‘å¸‚';
        }
        
        // æ›´æ–°æ’è¡Œæ¦œ
        if (data.rankings) {
            // å¯ä»¥å®ç°å¢é‡æ›´æ–°
        }
    });
    
    // æ·»åŠ ç³»ç»Ÿæ—¥å¿—
    function addSystemLog(message, type = 'info') {
        const logsContainer = document.getElementById('system-logs');
        const timestamp = new Date().toLocaleTimeString();
        
        const logEntry = document.createElement('div');
        logEntry.className = `alert alert-${type} alert-custom py-2 mb-2`;
        logEntry.innerHTML = `
            <small class="text-muted">${timestamp}</small><br>
            ${message}
        `;
        
        logsContainer.insertBefore(logEntry, logsContainer.firstChild);
        
        // é™åˆ¶æ—¥å¿—æ•°é‡
        const logs = logsContainer.children;
        if (logs.length > 10) {
            logsContainer.removeChild(logs[logs.length - 1]);
        }
    }
    
    // ç›‘å¬WebSocketäº‹ä»¶å¹¶æ·»åŠ åˆ°æ—¥å¿—
    socket.on('status', function(data) {
        addSystemLog(data.message, 'info');
    });
    
    socket.on('error', function(data) {
        addSystemLog(data.message, 'danger');
    });
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadSystemOverview();
        loadRankings();
        loadMarketInfo();
        
        // å®šæœŸåˆ·æ–°æ•°æ®
        setInterval(refreshData, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
        
        // æ·»åŠ æ¬¢è¿æ—¥å¿—
        setTimeout(() => {
            addSystemLog('æ¬¢è¿ä½¿ç”¨AI Trading Robotç³»ç»Ÿï¼', 'success');
        }, 1000);
    });
</script>
{% endblock %}